<!--
 * @Author: tf
 * @Date: 2021-04-07 16:33:49
 * @LastEditTime: 2021-04-14 15:41:46
 * @Description: 这是一段描述
-->

## 前端安全

### 1. XSS 跨站脚本攻击

就是攻击者想尽一切办法将可以执行的代码注入到网页中

- `存储型(server端)`
  - 场景：见于待用户保存数据的网站功能，如：论坛发帖、商品评论、私信等
  - 攻击步骤：
    - 攻击者将恶意代码提交到目标网站的数据库中
    - 用户将目标网站打开，从服务取出里面的恶意代码拼接成 HTML 返回到页面
    - 用户浏览器在收到响应之后解析执行，混在其中的恶意代码也被执行
    - 恶意代码窃取用户数据，并发送到攻击者指定的网站，或者冒充用户行为调用目标网站的服务，进行恶意操作
- `放射型(server端)`
  与存储型的区别是，放射型的攻击代码是在 URL 上，存储型的是在存在数据库中
  - 场景：通过 url 传递的参数攻击，如搜索、跳转等
  - 攻击步骤：
    - 攻击者包含恶意的代码在 url 上
    - 用户打开带有恶意代码的链接，网站服务将恶意代码取出，拼在 html 上面返回给浏览器
    - 用户浏览器接收到之后解析，混在里面的恶意代码也被执行
    - 恶意代码窃取用户数据，并发送到攻击者指定的网站，或者冒充用户行为调用目标网站的服务，进行恶意操作
- `DOM型(浏览器端)`
  Dom 型 xss 攻击中，取出恶意代码由浏览器完成，属于前端 javascript 自身的安全漏洞

  - 场景：通过 url 传递的参数攻击，如搜索、跳转等
  - 攻击步骤：

    - 攻击者包含恶意的代码在 url 上
    - 用户打开带有恶意代码的 url
    - 用户浏览器接收到之后解析，前端 javascript 取出代码执行，混在里面的恶意代码也被执行
    - 恶意代码窃取用户数据，并发送到攻击者指定的网站，或者冒充用户行为调用目标网站的服务，进行恶意操作

**预防方案**

- 对数据进行严格的编码，如 html 编码、js 编码、css 编码、url 编码，避免拼接 html;vue/react 技术栈避免使用 v-html/dangerouslySetInnerHTML
- CSP HTTP Header，即 Content-Security-Policy、X-XSS-Protection
  - 增加攻击难度，配置 CSP(本质是建立白名单，由浏览器拦截)
  - Content-Security-Policy: default-src 'self' -所有内容均来自站点的同一个源（不包括其子域名）
  - Content-Security-Policy: default-src 'self' \*.trusted.com-允许内容来自信任的域名及其子域名 (域名不必须与 CSP 设置所在的域名相同)
  - Content-Security-Policy: default-src https://baidu.com-该服务器仅允许通过HTTPS方式并仅从baicu.com域名来访问文档
- 输入验证：比如一些常见的数字、邮箱、url、电话号码进行判断
- 开启浏览器 XSS 防御，http only cookie，禁止 javascript 读取某些敏感 cookie，攻击者完成 XSS 注入后也无法窃取此 cookie
- 验证码

### 2. CSRF: 跨站请求伪造

攻击者诱导受害者进入第三方网站，在第三方网站中，向被攻击网站发送跨站请求，利用受害者在被攻击网站所取得的注册凭证绕过后台的验证，达到冒充用户到被攻击者的网站执行想的权利

- 攻击举例：
  - 受害者登录一个网站 a 并保留了登录凭证(cookie)
  - 攻击者引诱受害者访问另一个网站 b
  - 网站 b 向 a 发送了一个请求 a.com/act=xxx 浏览器会默认携带 a.com 的 cookie
  - 网站 a 接收到请求后，对请求进行认证，确认是用户的凭证，误以为是用户自己发送的请求
  - 网站 a 以用户的名义执行了 act=xxx
  - 攻击完成，攻击者在用户不知道的情况下，冒充了受害则，让网站 a 执行了自己定义的操作
- 攻击类型：
  - `get类型`：比如某个 img 发送了一个请求
  - `post类型`：通过自动提交表单到恶意网站
  - `链接型`：诱导用户点击恶意链接
- 预防方案：
  因为 CSRF 通常是通过第三方网站来发起攻击，所以只能提高自己网站的安全才能防备

  - 同源检测：通过 header 中的 origin header、referer header 确定，在不同浏览器会有不同的实现，不能完全保证
  - CSRF token 验证：将 CSRF token 输出到页面中（通常保存在 session 中），页面提交的请求带上这个 token,服务器验证 token 是否正确
  - 双重 cookie 验证：在用户访问页面的时候带一个 cookie(随机字符串)，前端像后端发起请求时携带这个 cookie,并且添加到 url 上，服务器验证 cookie 的字段是否是和 url 上面是一样的，不一致就拒绝

    **优点**

    无需使用 session,适用面更广，易于实施；token 存在客户端中，不会给服务器压力；相对于 token 实施成本更低，可以前后端统一校验拦截，不需要一个一个接口加

    **缺点**
    cookie 中增加了额外的字段。 -如果有其他漏洞（例如 XSS），攻击者可以注入 cookie，那么该防御方式失效。 -难以做到子域名的隔离。 -为了确保 cookie 传输安全，采用这种防御方式的最好确保用整站 HTTPS 的方式，如果还没切 HTTPS 的使用这种方式也会有风险。Cookie 的[SameSite 属性](http://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html)用来限制第三方 Cookie，从而减少安全风险

### 3、iframe

- 嵌入第三方 iframe 会有很多不可控的问题，同时当第三方 iframe 出现问题或被劫持之后，也会诱发安全性问题
- 点击劫持，攻击者将目标网站通过 iframe 前台的方式嵌入自己的网页中，并将 iframe 设置透明，诱导用户点击
- 禁止自己的 iframe 中的链接外部网站的 js

**预防方案**

- 为 iframe 设置 sandbox 属性，通过他可以对 iframe 的各种行为进行控制，充分实现**最小权限**原则
- 服务端设置 `X-Frame-Options Header`头，拒绝页面被嵌套，`X-Frame-Options`是 http 响应头中的用来告诉浏览器一个页面是否可以嵌入 iframe 中
- 设置 `CSP` 即`Content-Security-Policy`请求头
- 减少对 iframe 的使用

### 4、错误的内容推断

- 说明
  文件上传类型校验失败后，导致恶意的 js 文件上传后，浏览器默认的 content-type header 的解析为可执行的文件
- 预防方案
  设置 `X-Content-Type-Options` 头

### 5、第三方依赖包

减少第三方包的依赖，例如 event-stream 被爆出恶意攻击数字货币

### 6、HTTPS

- 描述
  黑客利用 SSL Stripping 这种攻击手段，强制让 HTTPS 降回 HTTP，从而继续从中间人攻击
- 预防方案
  使用 HSTS(HTTP Strict Transport Security),他通过下面的这个 http header 以及预加载的清单，来告知浏览器和网站进行通信的时候强制性的使用 Https,而不是通过明文的 HTTPS 进行通信，这里的强制性表现为浏览器无论在任何情况下都直接向服务端发起 HTTP 请求，而不再像以往那样从 HTTP 跳转到 HTTPS,另外，当遇到证书或者链接不安全的时候，首先警告用户，并且不在用户选择是否继续选择不安全的通信

### 7、本地存储数据

避免重要的用户信息存在浏览器缓存中

### 8、静态资源完整性校验

- 描述
  使用内推分发网络(CDN）在多个站点之间共享脚本和样式表等文件可以提高站点性能并节省带宽，但是使用 CDN 也会存在风险，如果攻击者获得对 CDN 的控制权，则可以将任意恶意内容注入到 CDN 上的文件中（或者替换掉文件），因此可能潜在的攻击所有从该 CDN 获取文件的站点
- 预防方案
  将使用 base64 编码过后的文件 hash 值写入你所引用的 script 标签和 link 标签的 integrity 属性中即可启用子资源完整性

### 9、网络劫持

- 描述
  - DNS 劫持(涉嫌违法)：修改运行商的 DNS 记录，重定向到其他网站，DNS 劫持是违法的行为，目前 DNS 劫持已经被监管，已经很少见了
  - HTTP 劫持：前提是有 HTTP 请求，因 HTTP 是明文传输，运营商便可借机修改 HTTP 响应内容（比如广告）
- 预防方案
  全站 HTTPS

### 10、中间人攻击

中间人攻击，指攻击者与通信的两端分别创建独立的联系，并交换其所收到的数据，使通讯的两端认为他们正在通过一个私密的链接与对方直接对话，但是事实上整个对话都会被窃听、篡改甚至控制，没有进行严格的证书校验是中间人攻击着手点。目前大多数加密协议都提供了一些特殊认证方法以阻止中间人攻击，比如 SSL 协议可以验证参与通讯的用户的证书是否有权威，受信任的数字证多户认证机构颁发，并且能执行双向身份认证，攻击场景如用户在一个未加密的 wifi 下访问网站，在中间人攻击中，攻击者可以拦截通讯双方的童话并插入新的内容

- 场景
  - 在一个未加密的 wifi 无线接入点的接受范围内的中间人攻击者，可以将自己作为一个中间人插入网站
  - Fidder/Charles 代理工具
  - 12306 之前的自己证书
- 过程
  - 客户端发送骑牛到服务器，请求被中间人截获
  - 服务器向客户端发送公钥
  - 中间人截获公钥，保留在自己手上，然后自己生成一个伪造的公钥，发送给客户端
  - 客户端收到伪造的公钥后，生成加密 hash 值发给服务器
  - 服务器用私钥解密获得假秘钥，然后加密数据传输给客户端
- 使用抓包工具 fiddle 来进行举例说明
  - 首先通过一些途径在客户端安装证书
  - 然后客户端发送链接请求，fiddle 在中间截取请求，并返回自己伪造的证书
  - 客户端已经安装了攻击者的根证书，所以验证通过
  - 客户端就会正常和 fiddle 进行通信，把 fiddle 当做正确的服务器
  - 同事 fiddle 会跟原有的服务器进行通信，获取数据以及加密的密钥，去解密密钥
- 常见的攻击方式
  1. 嗅探：嗅探是一种用来捕获流进和流出的网络数据包的技术
  2. 数据包注入：在这种，攻击者会将恶意数据包注入到常规数据中，因为这些恶意数据是在正常的数据里面的，用户和系统很难发现这个内容
  3. 会话劫持：当我们进行一个网站的登录的时候到退出登录这个时候，会产生一个会话，这个会话是攻击者用来攻击的首要目标，因为这个会话包含了用户大量的数据和私密信息
  4. SSL 剥离：HTTPS 是通过 SSL/TLS 进行加密过的，在 SSL 剥离攻击中，会使 SSL/TLS 断开，让受保护的 HTTPS 变成不收保护的 HTTP（这对于网站来说都挺致命）
  5. NDS 欺骗：攻击者往往通过入侵到 DNS 服务器，或者篡改用户的 host 文件，然后去劫持用户发的请求，然后转发到攻击者要转发的服务器
  6. ARP 欺骗：ARP 地址解析协议，攻击者利用 ARP 的漏洞，用当前局域网中的一台服务器，来冒充客服端想要请求的服务器，向客户端发送自己的 MAC 地址，客户端无从得到真正的主机的 MAC 地址，所以会把这个地址当做真正的主机来进行通信，将 MAC 存入 ARP 缓存表中
  7. 代理服务器
- 预防方案
  1. 用可信的第三方 CA 厂商
  2. 不下载未知来源的证书，不要下载一些不安全的文件
  3. 确认你访问的 URL 是 HTTPS，确保网站使用了 SSL，确保禁用一些不安全的 SSL，只开启 TSL1.1、TSL1.2
  4. 不要使用公用网络发送一些敏感的信息
  5. 不要去点击一些不安全的链接或者恶意链接和网站

### 11、sql 注入

就是通过 sql 命令插入到 web 表单提交或输入域名或网页请求的查询字符串，最终达到欺骗数据库服务器执行恶意的 sql 命令，从而达到和服务器进行直接的交互

**预防方案**

- 后台进行输入验证，对敏感字符过滤
- 使用参数化查询，能避免拼接 sql,就不要用拼接 sql 语句

### 12、前端数据安全

反爬虫，如猫眼电影，天眼查等，以数据内容为核心的企业

**预防方案**

- font-face 拼接方式：猫眼电影、天眼查
- background 拼接：美团
- 伪元素隐藏：汽车之家
- 元素定位覆盖式：去哪儿
- iframe 异步加载：网易云音乐

### 13、其他

- 定期请第三方机构做安全性测试，漏洞扫描
- 使用第三方开源库做上线前的安全
- code review 保证代码质量
- 默认项目中设置的 Header 请求，如`X-XSS-Protection`，`X-Content-Type-options`，`X-Frame-Options Header`，`Content-Security-Policy`等
- 对第三方包和库做检测 `NSP(Node Security Platform)`,`Snyk`
